;	dimmer_led_assembly.asm
;
; Created: 08/10/2020 00:55:58
; Author: Sergio Santos
;	<sergio.salazar.santos@gmail.com>
; Commnet:
;	stable
 .EQU REPEAT = 100 ; 100
 .EQU MASK = (1<<PD6)
 .INCLUDE<M88DEF.INC>
.ORG 0
	RJMP RESET
.ORG 0x002A
	RJMP ADC_vect
.ORG 0X001C
	RJMP TIM0_COMPA_vect
.ORG 0x100
RESET:
	LDI R16, HIGH(RAMEND)
	OUT SPH, R16
	LDI R16, LOW(RAMEND)
	OUT SPL, R16
	LDI R16, MASK
	LDI R17, MASK
	LDI R18, REPEAT
	SBI DDRD, 6
	CBI DDRB, (1<<PB1)
	CBI PORTD, 6
	RCALL TIMER0A_setup
	RCALL TIMER1A_setup
	RCALL ADC_setup
	RJMP MAIN

;--- Periodo 10ms Setup
TIMER0A_setup:
	LDI R19, (1<<OCIE0A) ;enable OCR0A interrupt
	STS TIMSK0, R19
	LDI R19, 156 ;OCR0A
	OUT OCR0A, R19
	LDI R19, (1<<WGM01) ;CTC
	OUT TCCR0A, R19
	LDI R19, (1<<CS02) ; N prescaler (1<<CS02)
	OUT TCCR0B, R19
	RET

TIMER1A_setup:
	LDI R19, (1<<WGM10)
	ORI R19, (3<<COM1A0)
	STS TCCR1A, R19
	LDI R19, (1<<WGM12)
	STS TCCR1B, R19
	SBI DDRB, PB1
	LDI R19, 128
	STS OCR1AL, R19
	LDS R19, TCCR1B
	ORI R19, (1<<CS12)
	STS TCCR1B, R19
	RET

ADC_setup:
	CBI DDRC, PC0
	LDI R19, (1<<REFS0)
	ORI R19, (1<<ADLAR)
	STS ADMUX, R19
	LDI R19, (7<<ADPS0)
	ORI R19, (1<<ADIE)
	ORI R19, (1<<ADEN)
	ORI R19, (1<<ADSC)
	ORI R19, (1<<ADATE)
	STS ADCSRA, R19
	SEI
	RET

MAIN:
	RJMP MAIN

.ORG 400
TIM0_COMPA_vect:
	DEC R18
	BREQ INIC
	RETI
INIC:
	LDI R18, REPEAT
	EOR R16, R17
	OUT PORTD, R16

.ORG 500
ADC_vect:
	LDS R20, ADCL
	LDS R20, ADCH
	STS OCR1AL, R20
	RETI
;EOF
;COMMENTS
;easy shit
